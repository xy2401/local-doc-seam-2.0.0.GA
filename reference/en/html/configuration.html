<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;25.&nbsp;Configuring Seam and packaging Seam applications</title><link rel="stylesheet" href="../shared/css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.65.1"><link rel="home" href="index.html" title="Seam - Contextual Components"><link rel="up" href="index.html" title="Seam - Contextual Components"><link rel="previous" href="search.html" title="Chapter&nbsp;24.&nbsp;Hibernate Search"><link rel="next" href="oc4j.html" title="Chapter&nbsp;26.&nbsp;Seam on OC4J"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;25.&nbsp;Configuring Seam and packaging Seam applications</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="search.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="oc4j.html">Next</a></td></tr></table><hr></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="configuration"></a>Chapter&nbsp;25.&nbsp;Configuring Seam and packaging Seam applications</h2></div></div><div></div></div><p> Configuration is a very boring topic and an extremely tedious pastime. Unfortunately, several lines of XML
        are required to integrate Seam into your JSF implementation and servlet container. There's no need to be too put
        off by the following sections; you'll never need to type any of this stuff yourself, since you can just copy and
        paste from the example applications! </p><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13374"></a>25.1.&nbsp;Basic Seam configuration</h2></div></div><div></div></div><p> First, let's look at the basic configuration that is needed whenever we use Seam with JSF. </p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13379"></a>25.1.1.&nbsp;Integrating Seam with JSF and your servlet container</h3></div></div><div></div></div><p> Of course, you need a faces servlet! </p><pre class="programlisting">&lt;servlet&gt;
    &lt;servlet-name&gt;Faces Servlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;javax.faces.webapp.FacesServlet&lt;/servlet-class&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;

&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;Faces Servlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;*.seam&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;</pre><p> (You can adjust the URL pattern to suit your taste.) </p><p> In addition, Seam requires the following entry in your <tt class="literal">web.xml</tt> file: </p><pre class="programlisting">&lt;listener&gt;
    &lt;listener-class&gt;org.jboss.seam.servlet.SeamListener&lt;/listener-class&gt;
&lt;/listener&gt;</pre><p> This listener is responsible for bootstrapping Seam, and for destroying session and application
                contexts. </p><p> Some JSF implementations have a broken implementation of server-side state saving that interferes
                with Seam's conversation propagation. If you have problems with conversation propagation during form
                submissions, try switching to client-side state saving. You'll need this in <tt class="literal">web.xml</tt>: </p><pre class="programlisting">&lt;context-param&gt;
    &lt;param-name&gt;javax.faces.STATE_SAVING_METHOD&lt;/param-name&gt;
    &lt;param-value&gt;client&lt;/param-value&gt;
&lt;/context-param&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13404"></a>25.1.2.&nbsp;Using facelets</h3></div></div><div></div></div><p> If you want follow our advice and use facelets instead of JSP, add the following lines to
                    <tt class="literal">faces-config.xml</tt>: </p><pre class="programlisting">&lt;application&gt;
    &lt;view-handler&gt;com.sun.facelets.FaceletViewHandler&lt;/view-handler&gt;
&lt;/application&gt;</pre><p> And the following lines to <tt class="literal">web.xml</tt>: </p><pre class="programlisting">&lt;context-param&gt;
    &lt;param-name&gt;javax.faces.DEFAULT_SUFFIX&lt;/param-name&gt;
    &lt;param-value&gt;.xhtml&lt;/param-value&gt;
&lt;/context-param&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13421"></a>25.1.3.&nbsp;Seam Resource Servlet</h3></div></div><div></div></div><p> The Seam Resource Servlet provides resources used by Seam Remoting, captchas (see the security
                chapter) and some JSF UI controls. Configuring the Seam Resource Servlet requires the following entry in
                    <tt class="literal">web.xml</tt>: </p><pre class="programlisting">&lt;servlet&gt;
  &lt;servlet-name&gt;Seam Resource Servlet&lt;/servlet-name&gt;
  &lt;servlet-class&gt;org.jboss.seam.servlet.SeamResourceServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
    
&lt;servlet-mapping&gt;
  &lt;servlet-name&gt;Seam Resource Servlet&lt;/servlet-name&gt;
  &lt;url-pattern&gt;/seam/resource/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13431"></a>25.1.4.&nbsp;Seam servlet filters</h3></div></div><div></div></div><p> Seam doesn't need any servlet filters for basic operation. However, there are several features which
                depend upon the use of filters. To make things easier, Seam lets you add and configure
                servlet filters just like you would configure other built-in Seam components. To take advantage of this
                feature, we must first install a master filter in <tt class="literal">web.xml</tt>: </p><pre class="programlisting">&lt;filter&gt;
    &lt;filter-name&gt;Seam Filter&lt;/filter-name&gt;
    &lt;filter-class&gt;org.jboss.seam.servlet.SeamFilter&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;Seam Filter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;</pre><p>The Seam master filter <span class="emphasis"><em>must</em></span> be the first filter specified in
                <tt class="literal">web.xml</tt>. This ensures it is run first. </p><p>To disable a built in filter, you can set <tt class="literal">disabled="true"</tt> on
            a particular filter.</p><p> Adding the master filter enables the following built-in filters. </p><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13456"></a>25.1.4.1.&nbsp;Exception handling</h4></div></div><div></div></div><p> This filter provides the exception mapping functionality in <tt class="literal">pages.xml</tt> (almost
                    all applications will need this). It also takes care of rolling back uncommitted transactions when
                    uncaught exceptions occur. (According to the Java EE specification, the web container should do this
                    automatically, but we've found that this behavior cannot be relied upon in all application servers.
                    And it is certainly not required of plain servlet engines like Tomcat.) </p><p> By default, the exception handling filter will process all requests, however this behavior may be
                    adjusted by adding a <tt class="literal">&lt;web:exception-filter&gt;</tt> entry to
                        <tt class="literal">components.xml</tt>, as shown in this example: </p><pre class="programlisting">&lt;components xmlns="http://jboss.com/products/seam/components"
            xmlns:web="http://jboss.com/products/seam/web"&gt;

    &lt;web:exception-filter url-pattern="*.seam"/&gt;

&lt;/components&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p>
                            <tt class="literal">url-pattern</tt> &#8212; Used to specify which requests are filtered, the
                            default is all requests. </p></li></ul></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13481"></a>25.1.4.2.&nbsp;Conversation propagation with redirects</h4></div></div><div></div></div><p> This filter allows Seam to propagate the conversation context across browser redirects. It
                    intercepts any browser redirects and adds a request parameter that specifies the Seam conversation
                    identifier. </p><p> The redirect filter will process all requests by default, but this behavior can also be adjusted
                    in <tt class="literal">components.xml</tt>: </p><pre class="programlisting">&lt;web:redirect-filter url-pattern="*.seam"/&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p>
                            <tt class="literal">url-pattern</tt> &#8212; Used to specify which requests are filtered, the
                            default is all requests. </p></li></ul></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13500"></a>25.1.4.3.&nbsp;Multipart form submissions</h4></div></div><div></div></div><p> This feature is necessary when using the Seam file upload JSF control. It detects multipart form
                    requests and processes them according to the multipart/form-data specification (RFC-2388). To
                    override the default settings, add the following entry to <tt class="literal">components.xml</tt>: </p><pre class="programlisting">&lt;web:multipart-filter create-temp-files="true" 
                      max-request-size="1000000" 
                      url-pattern="*.seam"/&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p>
                            <tt class="literal">create-temp-files</tt> &#8212; If set to <tt class="literal">true</tt>, uploaded
                            files are written to a temporary file (instead of held in memory). This may be an important
                            consideration if large file uploads are expected. The default setting is
                            <tt class="literal">false</tt>. </p></li><li><p>
                            <tt class="literal">max-request-size</tt> &#8212; If the size of a file upload request
                            (determined by reading the <tt class="literal">Content-Length</tt> header in the request) exceeds
                            this value, the request will be aborted. The default setting is 0 (no size limit). </p></li><li><p>
                            <tt class="literal">url-pattern</tt> &#8212; Used to specify which requests are filtered, the
                            default is all requests. </p></li></ul></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13538"></a>25.1.4.4.&nbsp;Character encoding</h4></div></div><div></div></div><p> Sets the character encoding of submitted form data. </p><p> This filter is not installed by default and requires an entry in
                    <tt class="literal">components.xml</tt> to enable it: </p><pre class="programlisting">&lt;web:character-encoding-filter encoding="UTF-16" 
                               override-client="true" 
                               url-pattern="*.seam"/&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p>
                            <tt class="literal">encoding</tt> &#8212; The encoding to use. </p></li><li><p>
                            <tt class="literal">override-client</tt> &#8212; If this is set to <tt class="literal">true</tt>,
                            the request encoding will be set to whatever is specified by <tt class="literal">encoding</tt> no
                            matter whether the request already specifies an encoding or not. If set to
                            <tt class="literal">false</tt>, the request encoding will only be set if the request doesn't
                            already specify an encoding. The default setting is <tt class="literal">false</tt>. </p></li><li><p>
                            <tt class="literal">url-pattern</tt> &#8212; Used to specify which requests are filtered, the
                            default is all requests. </p></li></ul></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13581"></a>25.1.4.5.&nbsp;RichFaces</h4></div></div><div></div></div><p> 
                  If RichFaces is used in your project, Seam will install the
                  RichFaces Ajax filter for you, making sure to install it
                  before all other built-in filters. You don't need to install
                  the RichFaces Ajax filter in <tt class="literal">web.xml</tt>
                  yourself.
                </p><p>
                  The RichFaces Ajax filter is only installed if the RichFaces
                  jars are present in your project.
                </p><p> To override the default settings, add the following entry to <tt class="literal">components.xml</tt>.
                    The options are the same as those specified in the RichFaces Developer Guide: </p><pre class="programlisting">&lt;web:ajax4jsf-filter force-parser="true" 
                     enable-cache="true" 
                     log4j-init-file="custom-log4j.xml"
                     url-pattern="*.seam"/&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p>
                            <tt class="literal">force-parser</tt> &#8212; forces all JSF pages to be validated by
                            Richfaces's XML syntax checker. If <tt class="literal">false</tt>, only AJAX responses are
                            validated and converted to well-formed XML. Setting <tt class="literal">force-parser</tt> to
                                <tt class="literal">false</tt> improves performance, but can provide visual artifacts on AJAX
                            updates. </p></li><li><p>
                            <tt class="literal">enable-cache</tt> &#8212; enables caching of framework-generated resources
                            (e.g. javascript, CSS, images, etc). When developing custom javascript or CSS, setting to
                            true prevents the browser from caching the resource. </p></li><li><p>
                            <tt class="literal">log4j-init-file</tt> &#8212; is used to setup per-application logging. A
                            path, relative to web application context, to the log4j.xml configuration file should be
                            provided. </p></li><li><p>
                            <tt class="literal">url-pattern</tt> &#8212; Used to specify which requests are filtered, the
                            default is all requests. </p></li></ul></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13632"></a>25.1.4.6.&nbsp;Identity Logging</h4></div></div><div></div></div><p> 
                    This filter adds the authenticated user name to the log4j mapped diagnostic context so that it 
                    can be included in formatted log output if desired, by adding %X{username} to the pattern.                       
                </p><p> By default, the logging filter will process all requests, however this behavior may be
                     adjusted by adding a <tt class="literal">&lt;web:logging-filter&gt;</tt> entry to
                     <tt class="literal">components.xml</tt>, as shown in this example: </p><pre class="programlisting">&lt;components xmlns="http://jboss.com/products/seam/components"
            xmlns:web="http://jboss.com/products/seam/web"&gt;
    &lt;web:logging-filter url-pattern="*.seam"/&gt;
&lt;/components&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p>
                            <tt class="literal">url-pattern</tt> &#8212; Used to specify which requests the filter is active for. The
                            default is all requests. </p></li></ul></div></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13654"></a>25.1.4.7.&nbsp;Context management for custom servlets</h4></div></div><div></div></div><p> Requests sent direct to some servlet other than the JSF servlet are not processed through the JSF
                    lifecycle, so Seam provides a servlet filter that can be applied to any other servlet that needs
                    access to Seam components. </p><p> This filter allows custom servlets to interact with the Seam contexts. It sets up the Seam
                    contexts at the beginning of each request, and tears them down at the end of the request. You should
                    make sure that this filter is <span class="emphasis"><em>never</em></span> applied to the JSF
                    <tt class="literal">FacesServlet</tt>. Seam uses the phase listener for context management in a JSF
                    request. </p><p> This filter is not installed by default and requires an entry in
                    <tt class="literal">components.xml</tt> to enable it: </p><pre class="programlisting">&lt;web:context-filter url-pattern="/media/*"/&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p>
                            <tt class="literal">url-pattern</tt> &#8212; Used to specify which requests are filtered, the
                            default is all requests. If the url-pattern is specified for the context filter, then the
                            filter will be enabled (unless explicitly disabled). </p></li></ul></div><p> The context filter expects to find the conversation id of any conversation context in a request
                    parameter named <tt class="literal">conversationId</tt>. You are responsible for ensuring that it gets
                    sent in the request. </p><p> You are also responsible for ensuring propagation of any new conversation id back to the client.
                    Seam exposes the conversation id as a property of the built in component
                    <tt class="literal">conversation</tt>. </p></div><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13691"></a>25.1.4.8.&nbsp;Adding custom filters</h4></div></div><div></div></div><p> Seam can install your filters for you, allowing you to specify <span class="emphasis"><em>where</em></span> in the
                    chain your filter is placed (the servlet specification doesn't provide a well defined order if you
                    specify your filters in a <tt class="literal">web.xml</tt>). Just add the <tt class="literal">@Filter</tt>
                    annotation to your Seam component (which must implement <tt class="literal">javax.servlet.Filter</tt>): </p><pre class="programlisting">@Startup
@Scope(APPLICATION)
@Name("org.jboss.seam.web.multipartFilter")
@BypassInterceptors
@Filter(within="org.jboss.seam.web.ajax4jsfFilter")
public class MultipartFilter extends AbstractFilter {</pre><p> Adding the <tt class="literal">@Startup</tt> annotation means thar the component is available during
                    Seam startup; bijection isn't available here (<tt class="literal">@BypassInterceptors</tt>); and the filter
                    should be further down the chain than the RichFaces filter
                        (<tt class="literal">@Filter(within="org.jboss.seam.web.ajax4jsfFilter")</tt>). </p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13721"></a>25.1.5.&nbsp;Integrating Seam with your EJB container</h3></div></div><div></div></div><p> We need to apply the <tt class="literal">SeamInterceptor</tt> to our Seam components. The simplest way to
                do this across an entire application is to add the following interceptor configuration in
                    <tt class="literal">ejb-jar.xml</tt>: </p><pre class="programlisting">&lt;interceptors&gt;
    &lt;interceptor&gt;
        &lt;interceptor-class&gt;org.jboss.seam.ejb.SeamInterceptor&lt;/interceptor-class&gt;
    &lt;/interceptor&gt;
&lt;/interceptors&gt;
   
&lt;assembly-descriptor&gt;
    &lt;interceptor-binding&gt;
        &lt;ejb-name&gt;*&lt;/ejb-name&gt;
        &lt;interceptor-class&gt;org.jboss.seam.ejb.SeamInterceptor&lt;/interceptor-class&gt;
    &lt;/interceptor-binding&gt;
&lt;/assembly-descriptor&gt;
</pre><p> Seam needs to know where to go to find session beans in JNDI. One way to do this is specify the
                    <tt class="literal">@JndiName</tt> annotation on every session bean Seam component. However, this is quite
                tedious. A better approach is to specify a pattern that Seam can use to calculate the JNDI name from the
                EJB name. Unfortunately, there is no standard mapping to global JNDI defined in the EJB3 specification,
                so this mapping is vendor-specific. We usually specify this option in <tt class="literal">components.xml</tt>. </p><p> For JBoss AS, the following pattern is correct: </p><pre class="programlisting">&lt;core:init jndi-name="myEarName/#{ejbName}/local" /&gt;</pre><p> Where <tt class="literal">myEarName</tt> is the name of the EAR in which the bean is deployed. </p><p> Outside the context of an EAR (when using the JBoss Embeddable EJB3 container), the following pattern
                is the one to use: </p><pre class="programlisting">&lt;core:init jndi-name="#{ejbName}/local" /&gt;</pre><p> You'll have to experiment to find the right setting for other application servers. Note that some
                servers (such as GlassFish) require you to specify JNDI names for all EJB components explicitly (and
                tediously). In this case, you can pick your own pattern ;-) </p><p>
                In an EJB3 environment, we recommend the use of a special built-in component for transaction management,
                that is fully aware of container transactions, and can correctly process transaction success events
                registered with the <tt class="literal">Events</tt> component. If you don't add this line to your 
                <tt class="literal">components.xml</tt> file, Seam won't know when container-managed transactions end:
            </p><pre class="programlisting">&lt;transaction:ejb-transaction/&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13767"></a>25.1.6.&nbsp;Don't forget!</h3></div></div><div></div></div><p> There is one final item you need to know about. You must place a <tt class="literal">seam.properties</tt>,
                    <tt class="literal">META-INF/seam.properties</tt> or <tt class="literal">META-INF/components.xml</tt> file in
                any archive in which your Seam components are deployed (even an empty properties file will do). At
                startup, Seam will scan any archives with <tt class="literal">seam.properties</tt> files for seam components. </p><p> In a web archive (WAR) file, you must place a <tt class="literal">seam.properties</tt> file in the
                    <tt class="literal">WEB-INF/classes</tt> directory if you have any Seam components included here. </p><p> That's why all the Seam examples have an empty <tt class="literal">seam.properties</tt> file. You can't
                just delete this file and expect everything to still work! </p><p> You might think this is silly and what kind of idiot framework designers would make an empty file
                affect the behavior of their software?? Well, this is a workaround for a limitation of the
                JVM&#8212;if we didn't use this mechanism, our next best option would be to force you to list every
                component explicitly in <tt class="literal">components.xml</tt>, just like some other competing frameworks do!
                I think you'll like our way better. </p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13802"></a>25.2.&nbsp;Configuring Seam in Java EE 5</h2></div></div><div></div></div><div class="mediaobject" align="center"><img src="../shared/images/ee5.png" align="middle"></div><p> If you're running in a Java EE 5 environment, this is all the configuration required to start using Seam! </p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13812"></a>25.2.1.&nbsp;Packaging</h3></div></div><div></div></div><p> Once you've packaged all this stuff together into an EAR, the archive structure will look something
                like this: </p><pre class="programlisting">my-application.ear/
    jboss-seam.jar
    lib/
        jboss-el.jar
    META-INF/
        MANIFEST.MF
        application.xml
    my-application.war/
        META-INF/
            MANIFEST.MF
        WEB-INF/
            web.xml
            components.xml
            faces-config.xml
            lib/
                jsf-facelets.jar
                jboss-seam-ui.jar
        login.jsp
        register.jsp
        ...
    my-application.jar/
        META-INF/
            MANIFEST.MF
            persistence.xml
        seam.properties
        org/
            jboss/
                myapplication/
                    User.class
                    Login.class
                    LoginBean.class
                    Register.class
                    RegisterBean.class
                    ...</pre><p>
                You should declare <tt class="literal">jboss-seam.jar</tt> as an ejb module in <tt class="literal">META-INF/application.xml</tt>; 
               <tt class="literal">jboss-el.jar</tt> should be placed in the EAR's lib directory (putting it in the EAR classpath.
            </p><p> If you want to use jBPM or Drools, you must include the needed jars in the EAR's lib directory.</p><p> If you want to use facelets (our recommendation), you must include
                <tt class="literal">jsf-facelets.jar</tt> in the <tt class="literal">WEB-INF/lib</tt> directory of the WAR. </p><p> If you want to use the Seam tag library (most Seam applications do), you must include
                    <tt class="literal">jboss-seam-ui.jar</tt> in the <tt class="literal">WEB-INF/lib</tt> directory of the WAR. If
                you want to use the PDF or email tag libraries, you need to put <tt class="literal">jboss-seam-pdf.jar</tt> or
                    <tt class="literal">jboss-seam-mail.jar</tt> in <tt class="literal">WEB-INF/lib</tt>. </p><p> If you want to use the Seam debug page (only works for applications using facelets), you must include
                    <tt class="literal">jboss-seam-debug.jar</tt> in the <tt class="literal">WEB-INF/lib</tt> directory of the WAR. </p><p> Seam ships with several example applications that are deployable in any Java EE container that
                supports EJB 3.0. </p><p> I really wish that was all there was to say on the topic of configuration but unfortunately we're
                only about a third of the way there. If you're too overwhelmed by all this tedious configuration stuff,
                feel free to skip over the rest of this section and come back to it later. </p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13869"></a>25.3.&nbsp;Configuring Seam in J2EE</h2></div></div><div></div></div><p> Seam is useful even if you're not yet ready to take the plunge into EJB 3.0. In this case you would use
            Hibernate3 or JPA instead of EJB 3.0 persistence, and plain JavaBeans instead of session beans. You'll miss
            out on some of the nice features of session beans but it will be very easy to migrate to EJB 3.0 when you're
            ready and, in the meantime, you'll be able to take advantage of Seam's unique declarative state management
            architecture. </p><div class="mediaobject" align="center"><img src="../shared/images/hibernate-ee.png" align="middle"></div><p> Seam JavaBean components do not provide declarative transaction demarcation like session beans do. You
                <span class="emphasis"><em>could</em></span> manage your transactions manually using the JTA
            <tt class="literal">UserTransaction</tt> or declaratively using Seam's <tt class="literal">@Transactional</tt>
            annotation. But most applications will just use Seam managed transactions when using Hibernate with
            JavaBeans. </p><p> The Seam distribution includes a version of the booking example application that uses Hibernate3 and
            JavaBeans instead of EJB3, and another version that uses JPA and JavaBeans. These example applications are
            ready to deploy into any J2EE application server. </p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13892"></a>25.3.1.&nbsp;Boostrapping Hibernate in Seam</h3></div></div><div></div></div><p> Seam will bootstrap a Hibernate <tt class="literal">SessionFactory</tt> from your
                    <tt class="literal">hibernate.cfg.xml</tt> file if you install a built-in component: </p><pre class="programlisting">&lt;persistence:hibernate-session-factory name="hibernateSessionFactory"/&gt;</pre><p> You will also need to configure a <span class="emphasis"><em>managed session</em></span> if you want a Seam managed
                Hibernate <tt class="literal">Session</tt> to be available via injection. </p><pre class="programlisting">&lt;persistence:managed-hibernate-session name="hibernateSessionFactory"
                            session-factory="#{hibernateSessionFactory}"/&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13915"></a>25.3.2.&nbsp;Boostrapping JPA in Seam</h3></div></div><div></div></div><p> Seam will bootstrap a JPA <tt class="literal">EntityManagerFactory</tt> from your
                <tt class="literal">persistence.xml</tt> file if you install this built-in component: </p><pre class="programlisting">&lt;persistence:entity-manager-factory name="entityManagerFactory"/&gt;</pre><p> You will also need to configure a <span class="emphasis"><em>managed persistence context</em></span> if you want a
                Seam managed JPA <tt class="literal">EntityManager</tt> to be available via injection. </p><pre class="programlisting">&lt;persistence:managed-persistence-context name="entityManager"
                            entity-manager-factory="#{entityManagerFactory}"/&gt;</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13938"></a>25.3.3.&nbsp;Packaging</h3></div></div><div></div></div><p> We can package our application as a WAR, in the following structure: </p><pre class="programlisting">my-application.war/
    META-INF/
        MANIFEST.MF
    WEB-INF/
        web.xml
        components.xml
        faces-config.xml
        lib/
            jboss-seam.jar
            jboss-seam-ui.jar
            jboss-el.jar
            jsf-facelets.jar
            hibernate3.jar
            hibernate-annotations.jar
            hibernate-validator.jar
            ...
            my-application.jar/
                META-INF/
                   MANIFEST.MF
                seam.properties
                hibernate.cfg.xml
                org/
                    jboss/
                        myapplication/
                            User.class
                            Login.class
                            Register.class
                            ...
    login.jsp
    register.jsp
    ...</pre><p> If we want to deploy Hibernate in a non-EE environment like Tomcat or TestNG, we need to do a little
                bit more work. </p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13947"></a>25.4.&nbsp;Configuring Seam in Java SE, without JBoss Embedded</h2></div></div><div></div></div><p> It is possible to use Seam completely outside of an EE environment. In this case, you need to tell Seam
            how to manage transactions, since there will be no JTA available. If you're using JPA, you can tell
            Seam to use JPA resource-local transactions, ie. <tt class="literal">EntityTransaction</tt>, like so: </p><pre class="programlisting">&lt;transaction:entity-transaction entity-manager="#{entityManager}"/&gt;</pre><p> If you're using Hibernate, you can tell Seam to use the Hibernate transaction API like this: </p><pre class="programlisting">&lt;transaction:hibernate-transaction session="#{session}"/&gt;</pre><p> Of course, you'll also need to define a datasource.</p><p> A better alternative is to use JBoss Embedded to get access to the EE APIs. </p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13965"></a>25.5.&nbsp;Configuring Seam in Java SE, with JBoss Embedded</h2></div></div><div></div></div><p> JBoss Embedded lets you run EJB3 components outside the context of the Java EE 5 application server. This
            is especially, but not only, useful for testing. </p><p> The Seam booking example application includes a TestNG integration test suite that runs on JBoss Embedded
            via <tt class="literal">SeamTest</tt>. </p><div class="mediaobject" align="center"><img src="../shared/images/testng.png" align="middle"></div><p> The booking example application may even be deployed to Tomcat. </p><div class="mediaobject" align="center"><img src="../shared/images/e-ejb3.png" align="middle"></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="config.install.embedded"></a>25.5.1.&nbsp;Installing Embedded JBoss</h3></div></div><div></div></div><p>
              Embedded JBoss must by installed into Tomcat for Seam applications
              to run correctly on it. Embedded JBoss only runs on JDK 1.5 (not JDK 1.6). 
              Embedded JBoss can be downloaded 
              <a href="http://sourceforge.net/project/showfiles.php?group_id=22866&amp;package_id=228977" target="_top">here</a>.
              The process for installing Embedded JBoss into Tomcat 6 is quite 
              simple. First, you should copy the Embedded JBoss JARs and 
              configuration files into Tomcat. 
            </p><div class="itemizedlist"><ul type="disc"><li><p> Copy all files and directories under the Embedded JBoss <tt class="literal">bootstrap</tt> and
                            <tt class="literal">lib</tt> directories, except for the <tt class="literal">jndi.properties</tt> file,
                        into the Tomcat <tt class="literal">lib</tt> directory. </p></li><li><p>Remove the <tt class="literal">annotations-api.jar</tt> file from the Tomcat <tt class="literal">lib</tt>
                        directory. </p></li></ul></div><p>Next, two configuration files need to be updated to add Embedded JBoss-specific functionality.</p><div class="itemizedlist"><ul type="disc"><li><p> Add the Embedded JBoss listener to <tt class="literal">conf/server.xml</tt>. It should appear after
                        all other listeners in the file.</p><pre class="programlisting">&lt;Listener className="org.jboss.embedded.tomcat.EmbeddedJBossBootstrapListener" /&gt;</pre></li><li><p>WAR file scanning should be enabled by adding a listener to
                            <tt class="literal">conf/context.xml</tt>. </p><pre class="programlisting">&lt;Listener className="org.jboss.embedded.tomcat.WebinfScanner" /&gt;</pre></li></ul></div><p>For more configuration options, please see the Embedded JBoss Tomcat integration 
                <a href="http://wiki.jboss.org/wiki/Wiki.jsp?page=EmbeddedAndTomcat" target="_top">wiki entry</a>.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14044"></a>25.5.2.&nbsp;Packaging</h3></div></div><div></div></div><p> The archive structure of a WAR-based deployment on an servlet engine like Tomcat will look something
                like this: </p><pre class="programlisting">my-application.war/
    META-INF/
        MANIFEST.MF
    WEB-INF/
        web.xml
        components.xml
        faces-config.xml
        lib/
            jboss-seam.jar
            jboss-seam-ui.jar
            jboss-el.jar
            jsf-facelets.jar
            jsf-api.jar
            jsf-impl.jar
            ...
            my-application.jar/
                META-INF/
                    MANIFEST.MF
                    persistence.xml
                seam.properties
                org/
                    jboss/
                        myapplication/
                            User.class
                            Login.class
                            LoginBean.class
                            Register.class
                            RegisterBean.class
                            ...
    login.jsp
    register.jsp
    ...</pre><p> Most of the Seam example applications may be deployed to Tomcat by running <tt class="literal">ant
                deploy.tomcat</tt>. </p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14056"></a>25.6.&nbsp;Configuring jBPM in Seam</h2></div></div><div></div></div><p> Seam's jBPM integration is not installed by default, so you'll need to enable jBPM by installing a
            built-in component. You'll also need to explicitly list your process and pageflow definitions. In
                <tt class="literal">components.xml</tt>: </p><pre class="programlisting">&lt;bpm:jbpm&gt;
    &lt;bpm:pageflow-definitions&gt;
        &lt;value&gt;createDocument.jpdl.xml&lt;/value&gt;
        &lt;value&gt;editDocument.jpdl.xml&lt;/value&gt;
        &lt;value&gt;approveDocument.jpdl.xml&lt;/value&gt;
    &lt;/bpm:pageflow-definitions&gt;
    &lt;bpm:process-definitions&gt;
        &lt;value&gt;documentLifecycle.jpdl.xml&lt;/value&gt;
    &lt;/bpm:process-definitions&gt;
&lt;/bpm:jbpm&gt;</pre><p> No further special configuration is needed if you only have pageflows. If you do have business process
            definitions, you need to provide a jBPM configuration, and a Hibernate configuration for jBPM. The Seam DVD
            Store demo includes example <tt class="literal">jbpm.cfg.xml</tt> and <tt class="literal">hibernate.cfg.xml</tt> files
            that will work with Seam: </p><pre class="programlisting">&lt;jbpm-configuration&gt;

  &lt;jbpm-context&gt;
    &lt;service name="persistence"&gt;
       &lt;factory&gt;
          &lt;bean class="org.jbpm.persistence.db.DbPersistenceServiceFactory"&gt;
             &lt;field name="isTransactionEnabled"&gt;&lt;false/&gt;&lt;/field&gt;
          &lt;/bean&gt;
       &lt;/factory&gt;
    &lt;/service&gt;
    &lt;service name="tx" factory="org.jbpm.tx.TxServiceFactory" /&gt;
    &lt;service name="message" factory="org.jbpm.msg.db.DbMessageServiceFactory" /&gt;
    &lt;service name="scheduler" factory="org.jbpm.scheduler.db.DbSchedulerServiceFactory" /&gt;
    &lt;service name="logging" factory="org.jbpm.logging.db.DbLoggingServiceFactory" /&gt;
    &lt;service name="authentication" 
             factory="org.jbpm.security.authentication.DefaultAuthenticationServiceFactory" /&gt;
  &lt;/jbpm-context&gt;

&lt;/jbpm-configuration&gt;</pre><p> The most important thing to notice here is that jBPM transaction control is disabled. Seam or EJB3 should
            control the JTA transactions. </p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14078"></a>25.6.1.&nbsp;Packaging</h3></div></div><div></div></div><p> There is not yet any well-defined packaging format for jBPM configuration and process/pageflow
                definition files. In the Seam examples we've decided to simply package all these files into the root of
                the EAR. In future, we will probably design some other standard packaging format. So the EAR looks
                something like this: </p><pre class="programlisting">my-application.ear/
    jboss-seam.jar
    lib/
       jboss-el.jar
       jbpm-3.1.jar
    META-INF/
        MANIFEST.MF
        application.xml
    my-application.war/
        META-INF/
            MANIFEST.MF
        WEB-INF/
            web.xml
            components.xml
            faces-config.xml
            lib/
                jsf-facelets.jar
                jboss-seam-ui.jar
        login.jsp
        register.jsp
        ...
    my-application.jar/
        META-INF/
            MANIFEST.MF
            persistence.xml
        seam.properties
        org/
            jboss/
                myapplication/
                    User.class
                    Login.class
                    LoginBean.class
                    Register.class
                    RegisterBean.class
                    ...
    jbpm.cfg.xml
    hibernate.cfg.xml
    createDocument.jpdl.xml
    editDocument.jpdl.xml
    approveDocument.jpdl.xml
    documentLifecycle.jpdl.xml</pre></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14085"></a>25.7.&nbsp;Configuring Seam in a Portal</h2></div></div><div></div></div><p> To run a Seam application as a portlet, you'll need to provide certain portlet metadata
                (<tt class="literal">portlet.xml</tt>, etc) in addition to the usual Java EE metadata. See the
                <tt class="literal">examples/portal</tt> directory for an example of the booking demo preconfigured to run on
            JBoss Portal. </p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14096"></a>25.8.&nbsp;Configuring SFSB and Session Timeouts in JBoss AS</h2></div></div><div></div></div><p> It is very important that the timeout for Stateful Session Beans is set higher than the timeout for HTTP
            Sessions, otherwise SFSB's may time out before the user's HTTP session has ended. JBoss Application Server
            has a default session bean timeout of 30 minutes, which is configured in
                <tt class="literal">server/default/conf/standardjboss.xml</tt> (replace <span class="emphasis"><em>default</em></span> with your
            own configuration). </p><p> The default SFSB timeout can be adjusted by modifying the value of <tt class="literal">max-bean-life</tt> in
            the <tt class="literal">LRUStatefulContextCachePolicy</tt> cache configuration: </p><pre class="programlisting">&lt;container-cache-conf&gt;
    &lt;cache-policy&gt;org.jboss.ejb.plugins.LRUStatefulContextCachePolicy&lt;/cache-policy&gt;
    &lt;cache-policy-conf&gt;
        &lt;min-capacity&gt;50&lt;/min-capacity&gt;
        &lt;max-capacity&gt;1000000&lt;/max-capacity&gt;
        &lt;remover-period&gt;1800&lt;/remover-period&gt;

        &lt;!-- SFSB timeout in seconds; 1800 seconds == 30 minutes --&gt;
        &lt;max-bean-life&gt;1800&lt;/max-bean-life&gt;  

        &lt;overager-period&gt;300&lt;/overager-period&gt;
        &lt;max-bean-age&gt;600&lt;/max-bean-age&gt;
        &lt;resizer-period&gt;400&lt;/resizer-period&gt;
        &lt;max-cache-miss-period&gt;60&lt;/max-cache-miss-period&gt;
        &lt;min-cache-miss-period&gt;1&lt;/min-cache-miss-period&gt;
        &lt;cache-load-factor&gt;0.75&lt;/cache-load-factor&gt;
    &lt;/cache-policy-conf&gt;
&lt;/container-cache-conf&gt;</pre><p> The default HTTP session timeout can be modified in
                <tt class="literal">server/default/deploy/jbossweb-tomcat55.sar/conf/web.xml</tt> for JBoss 4.0.x, or in
                <tt class="literal">server/default/deploy/jboss-web.deployer/conf/web.xml</tt> for JBoss 4.2.x. The following
            entry in this file controls the default session timeout for all web applications: </p><pre class="programlisting">&lt;session-config&gt;
    &lt;!-- HTTP Session timeout, in minutes --&gt;
    &lt;session-timeout&gt;30&lt;/session-timeout&gt;
&lt;/session-config&gt;</pre><p> To override this value for your own application, simply include this entry in your application's own
                <tt class="literal">web.xml</tt>. </p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="search.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="index.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="oc4j.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;24.&nbsp;Hibernate Search&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;26.&nbsp;Seam on OC4J</td></tr></table></div></body></html>